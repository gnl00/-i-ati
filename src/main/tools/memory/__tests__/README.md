# Memory Tools æµ‹è¯•æ–‡æ¡£

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº† memory_save å’Œ memory_retrieval å·¥å…·çš„æµ‹è¯•ç”¨ä¾‹ã€‚

## ğŸ§ª æµ‹è¯•æ–‡ä»¶

- **ä½ç½®**: `src/main/tools/memory/__tests__/MemoryToolsProcessor.test.ts`
- **æµ‹è¯•æ¡†æ¶**: Vitest
- **æµ‹è¯•æ•°é‡**: 9 ä¸ªæµ‹è¯•ç”¨ä¾‹
- **Mock ç­–ç•¥**: ä½¿ç”¨ vi.mock æ¨¡æ‹Ÿ MemoryService

## ğŸ“ æµ‹è¯•ç”¨ä¾‹åˆ—è¡¨

### processMemorySave æµ‹è¯• (3ä¸ª)

1. **åº”è¯¥æˆåŠŸä¿å­˜å¸¦å®Œæ•´ metadata çš„è®°å¿†**
   - æµ‹è¯•ä¿å­˜å¸¦ categoryã€importanceã€tags çš„è®°å¿†
   - éªŒè¯ MemoryService.addMemory è¢«æ­£ç¡®è°ƒç”¨

2. **åº”è¯¥æˆåŠŸä¿å­˜ä¸å¸¦ metadata çš„è®°å¿†**
   - æµ‹è¯•å¯é€‰å‚æ•°çš„å¤„ç†
   - éªŒè¯é»˜è®¤ role ä¸º 'system'

3. **åº”è¯¥éªŒè¯ addMemory è¢«æ­£ç¡®è°ƒç”¨**
   - æµ‹è¯•å‚æ•°ä¼ é€’çš„æ­£ç¡®æ€§
   - éªŒè¯ chatIdã€roleã€contentã€metadata

### processMemoryRetrieval æµ‹è¯• (6ä¸ª)

4. **åº”è¯¥æˆåŠŸæ£€ç´¢ç›¸å…³è®°å¿†**
   - æµ‹è¯•åŸºæœ¬æ£€ç´¢åŠŸèƒ½
   - éªŒè¯è¿”å›ç»“æ„å’Œ MemoryService è°ƒç”¨

5. **åº”è¯¥è¿”å›å¸¦ç›¸ä¼¼åº¦åˆ†æ•°çš„è®°å¿†**
   - æµ‹è¯•ç›¸ä¼¼åº¦åˆ†æ•°åœ¨ [0, 1] èŒƒå›´å†…
   - éªŒè¯è¿”å›æ•°æ®ç»“æ„å®Œæ•´æ€§

6. **åº”è¯¥éµå®ˆ topK å‚æ•°é™åˆ¶**
   - æµ‹è¯•ç»“æœæ•°é‡ä¸è¶…è¿‡ topK
   - éªŒè¯å‚æ•°ä¼ é€’æ­£ç¡®

7. **åº”è¯¥éµå®ˆ threshold é˜ˆå€¼è¿‡æ»¤**
   - æµ‹è¯•ä½ç›¸ä¼¼åº¦ç»“æœè¢«è¿‡æ»¤
   - éªŒè¯é˜ˆå€¼å‚æ•°ç”Ÿæ•ˆ

8. **åº”è¯¥åœ¨æ— åŒ¹é…æ—¶è¿”å›ç©ºç»“æœ**
   - æµ‹è¯•ç©ºç»“æœå¤„ç†
   - éªŒè¯æç¤ºæ¶ˆæ¯æ­£ç¡®

9. **åº”è¯¥æŒ‰ chatId è¿‡æ»¤è®°å¿†**
   - æµ‹è¯• chatId å‚æ•°ä¼ é€’
   - éªŒè¯ä¸åŒ chat çš„éš”ç¦»

## ğŸš€ è¿è¡Œæµ‹è¯•

### è¿è¡Œå‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œ memory å·¥å…·æµ‹è¯•
npm test memory

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
npm test src/main/tools/memory/__tests__/MemoryToolsProcessor.test.ts

# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
npm test -- --reporter=verbose

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm test -- --coverage

# ç›‘å¬æ¨¡å¼è¿è¡Œæµ‹è¯•
npm test -- --watch
```

## ğŸ“Š é¢„æœŸç»“æœ

æ‰€æœ‰ 9 ä¸ªæµ‹è¯•åº”è¯¥é€šè¿‡:

```
âœ“ src/main/tools/memory/__tests__/MemoryToolsProcessor.test.ts (9)
  âœ“ MemoryToolsProcessor (9)
    âœ“ processMemorySave (3)
      âœ“ åº”è¯¥æˆåŠŸä¿å­˜å¸¦å®Œæ•´ metadata çš„è®°å¿†
      âœ“ åº”è¯¥æˆåŠŸä¿å­˜ä¸å¸¦ metadata çš„è®°å¿†
      âœ“ åº”è¯¥éªŒè¯ addMemory è¢«æ­£ç¡®è°ƒç”¨
    âœ“ processMemoryRetrieval (6)
      âœ“ åº”è¯¥æˆåŠŸæ£€ç´¢ç›¸å…³è®°å¿†
      âœ“ åº”è¯¥è¿”å›å¸¦ç›¸ä¼¼åº¦åˆ†æ•°çš„è®°å¿†
      âœ“ åº”è¯¥éµå®ˆ topK å‚æ•°é™åˆ¶
      âœ“ åº”è¯¥éµå®ˆ threshold é˜ˆå€¼è¿‡æ»¤
      âœ“ åº”è¯¥åœ¨æ— åŒ¹é…æ—¶è¿”å›ç©ºç»“æœ
      âœ“ åº”è¯¥æŒ‰ chatId è¿‡æ»¤è®°å¿†

Test Files  1 passed (1)
Tests  9 passed (9)
```

## ğŸ­ Mock ç­–ç•¥

æµ‹è¯•ä½¿ç”¨ `vi.mock` æ¨¡æ‹Ÿ MemoryServiceï¼Œé¿å…ä¾èµ–çœŸå®çš„æ•°æ®åº“å’Œ embedding æ¨¡å‹ï¼š

- **addMemory**: æ¨¡æ‹Ÿä¿å­˜è®°å¿†ï¼Œè¿”å›å¸¦ id çš„è®°å¿†å¯¹è±¡
- **searchMemories**: æ¨¡æ‹Ÿè¯­ä¹‰æœç´¢ï¼ŒåŸºäºå…³é”®è¯åŒ¹é…è¿”å›ç»“æœ
- **deleteMemory**: æ¨¡æ‹Ÿåˆ é™¤æ“ä½œ
- **clear**: æ¨¡æ‹Ÿæ¸…ç©ºæ“ä½œ

è¿™ç§æ–¹å¼ä½¿æµ‹è¯•ï¼š
- âœ… è¿è¡Œé€Ÿåº¦å¿«ï¼ˆæ— éœ€åŠ è½½æ¨¡å‹ï¼‰
- âœ… ç‹¬ç«‹å¯é ï¼ˆä¸ä¾èµ–å¤–éƒ¨èµ„æºï¼‰
- âœ… æ˜“äºç»´æŠ¤ï¼ˆä¸“æ³¨äºå·¥å…·é€»è¾‘ï¼‰

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [Vitest å®˜æ–¹æ–‡æ¡£](https://vitest.dev/)
- [EmbeddingService æµ‹è¯•ç¤ºä¾‹](../../../main/services/embedding/__tests__/EmbeddingService.test.ts)
- [MemoryService å®ç°](../../../main/services/MemoryService.ts)
- [Memory Tools å®šä¹‰](../../definitions/memory_tools.ts)
