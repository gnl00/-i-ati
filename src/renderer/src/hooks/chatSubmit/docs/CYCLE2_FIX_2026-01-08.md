# 修复 Cycle 2 内容追加到 Cycle 1 Assistant 消息

## 优化日期
2026-01-08

## 问题描述

### 原始问题

**Cycle 1**: 用户发消息 → 助手工具调用 → 执行工具
**Cycle 2**: 发送工具结果 → 助手响应

**问题**: Cycle 2 的响应内容被追加到 tool 消息上，而不是 Cycle 1 的 assistant 消息上。

### 根本原因

```typescript
// session.messageEntities 的状态
Cycle 1 结束: [user(259), assistant(260), tool(无id)]
Cycle 2 开始: getLastMessage() 返回 tool(无id) ❌

// 导致 Cycle 2 的内容被追加到 tool 消息
```

---

## 解决方案

### 核心思路

添加 `getLastAssistantMessage()` 和 `updateLastAssistantMessage()` 方法，确保始终操作最后一条 assistant 消息。

---

## 修改内容

### 1. MessageManager - 添加新方法

**文件**: `src/renderer/src/hooks/chatSubmit/message-manager.ts`

**新增方法 1**: `getLastAssistantMessage()` (line 180-188)
```typescript
getLastAssistantMessage(): MessageEntity {
  const entities = this.context.session.messageEntities
  for (let i = entities.length - 1; i >= 0; i--) {
    if (entities[i].body.role === 'assistant') {
      return entities[i]
    }
  }
  throw new Error('No assistant message found')
}
```

**新增方法 2**: `updateLastAssistantMessage()` (line 69-85)
```typescript
updateLastAssistantMessage(updater: (message: MessageEntity) => MessageEntity): void {
  try {
    const entities = this.context.session.messageEntities
    for (let i = entities.length - 1; i >= 0; i--) {
      if (entities[i].body.role === 'assistant') {
        const updated = updater(entities[i])
        entities[i] = updated
        this.store.upsertMessage(updated)
        return
      }
    }
    throw new Error('No assistant message found')
  } catch (error) {
    logger.error('Failed to update last assistant message', error as Error)
  }
}
```

### 2. Orchestrator - 修改 applyParseResult

**文件**: `src/renderer/src/hooks/chatSubmit/streaming/orchestrator.ts`

**修改前** (line 248):
```typescript
const lastMessage = this.config.messageManager.getLastMessage()
```

**修改后** (line 250):
```typescript
const lastMessage = this.config.messageManager.getLastAssistantMessage()
```

**修改前** (line 272):
```typescript
this.config.messageManager.updateLastMessage(msg => ({
  ...msg,
  body: { ...msg.body, segments }
}))
```

**修改后** (line 270):
```typescript
this.config.messageManager.updateLastAssistantMessage(msg => ({
  ...msg,
  body: { ...msg.body, segments }
}))
```

---

## 修复后的流程

```
Cycle 1:
├─ session.messageEntities = [user(259), assistant(260)]
├─ 接收响应，检测到 tool calls
├─ getLastAssistantMessage() → assistant(260) ✅
├─ 追加 segments 到 assistant(260)
├─ 执行工具
├─ session.messageEntities = [user(259), assistant(260), tool(无id)]

Cycle 2:
├─ session.messageEntities = [user(259), assistant(260), tool(无id)]
├─ 接收响应
├─ getLastAssistantMessage() → assistant(260) ✅ 正确！
├─ 追加 segments 到 assistant(260) ✅
└─ 结果：Cycle 2 的内容正确追加到 Cycle 1 的 assistant 消息
```

---

## 测试验证

### 预期结果

**Console 日志**:
```
[Orchestrator] Starting cycle 1
[Tool] Starting: write_file
[Tool] Completed: write_file (8ms)
[Orchestrator] Tools executed, continuing to next cycle
[Orchestrator] Starting cycle 2
[Orchestrator] No more tool calls, completed in 2 cycles
```

**session.messageEntities**:
```
[
  user(259),
  assistant(260) {  // Cycle 1 和 Cycle 2 的内容都在这里
    segments: [
      { type: 'text', content: 'Cycle 1 的内容...' },
      { type: 'toolCall', name: 'write_file', ... },
      { type: 'text', content: 'Cycle 2 的内容...' }  ✅
    ]
  },
  tool(无id)
]
```

**UI 渲染**:
- user message
- assistant message（包含 Cycle 1 和 Cycle 2 的完整内容）

---

## 影响文件

- `src/renderer/src/hooks/chatSubmit/message-manager.ts`
- `src/renderer/src/hooks/chatSubmit/streaming/orchestrator.ts`
