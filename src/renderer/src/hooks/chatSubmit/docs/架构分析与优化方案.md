# V2 æ¶æ„æ·±åº¦åˆ†æä¸ä¼˜åŒ–æ–¹æ¡ˆ

## ä¸€ã€å½“å‰æ¶æ„æ¦‚è§ˆ

### 1.1 æ ¸å¿ƒç»„ä»¶

```
useChatSubmit (Hook)
    â†“
ChatPipelineMachineV2 (çŠ¶æ€æœº)
    â†“
PipelineBuilderV2 (æ•°æ®å®¹å™¨)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ä¸ªå¤„ç†é˜¶æ®µï¼š                         â”‚
â”‚  1. prepareV2       â†’ PreparedChat    â”‚
â”‚  2. buildRequestV2  â†’ PreparedRequest â”‚
â”‚  3. createStreamingV2 â†’ StreamingContext â”‚
â”‚  4. finalizePipelineV2 â†’ void         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å·²å®Œæˆçš„ä¼˜åŒ–

âœ… **Phase 1: MessageManager** - ç»Ÿä¸€æ¶ˆæ¯çŠ¶æ€ç®¡ç†
- åŸå­æ›´æ–°æ¶ˆæ¯ï¼ˆè‡ªåŠ¨åŒæ­¥ 3 ä¸ªåœ°æ–¹ï¼‰
- æ¶ˆé™¤æ‰‹åŠ¨åŒæ­¥ä»£ç 
- ç±»å‹å®‰å…¨çš„æ›´æ–°æ–¹æ³•

âœ… **Phase 2: ToolExecutor** - å¹¶å‘å·¥å…·æ‰§è¡Œ
- ä»ä¸²è¡Œæ”¹ä¸ºå¹¶å‘æ‰§è¡Œï¼ˆæœ€å¤š 3 ä¸ªå¹¶å‘ï¼‰
- ä»£ç è¡Œæ•°å‡å°‘ 60%
- ç»Ÿä¸€é”™è¯¯å¤„ç†
- è¿›åº¦å›è°ƒæ”¯æŒ

âœ… **Parser å±‚** - æ¶ˆæ¯è§£æé€»è¾‘ç‹¬ç«‹
- ChunkParser: åè°ƒæ‰€æœ‰å­è§£æå™¨
- ThinkTagParser: å¤„ç† `<think>` æ ‡ç­¾
- ToolCallParser: å¤„ç†å·¥å…·è°ƒç”¨
- SegmentBuilder: æ™ºèƒ½åˆå¹¶ segments

---

## äºŒã€å½“å‰æ¶æ„å­˜åœ¨çš„é—®é¢˜

### 2.1 ä¸¥é‡é—®é¢˜ ğŸ”´

#### é—®é¢˜ 1: StreamingSessionMachine èŒè´£è¿‡é‡

**ä½ç½®**: `streaming.ts:115-330`

**é—®é¢˜æè¿°**:
```typescript
class StreamingSessionMachine {
  // èŒè´£1: æµå¼è¯·æ±‚ç®¡ç†
  private async runSingleRequest() { ... }

  // èŒè´£2: éæµå¼å“åº”å¤„ç†
  private applyNonStreamingResponse() { ... }

  // èŒè´£3: å·¥å…·è°ƒç”¨ç¼–æ’
  private async handleToolCalls() { ... }

  // èŒè´£4: å·¥å…·è°ƒç”¨å ä½ç¬¦åˆ·æ–°
  private flushToolCallPlaceholder() { ... }

  // èŒè´£5: ä¸»å¾ªç¯æ§åˆ¶
  async start() { ... }
}
```

**å½±å“**:
- å•ä¸ªç±»æ‰¿æ‹… 5 ä¸ªèŒè´£ï¼Œè¿åå•ä¸€èŒè´£åŸåˆ™
- éš¾ä»¥æµ‹è¯•ï¼ˆéœ€è¦ mock æ•´ä¸ª contextï¼‰
- éš¾ä»¥æ‰©å±•ï¼ˆæ·»åŠ æ–°åŠŸèƒ½éœ€è¦ä¿®æ”¹æ ¸å¿ƒç±»ï¼‰
- ä»£ç è¡Œæ•°è¿‡å¤šï¼ˆ330+ è¡Œï¼‰

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜
**ä¼˜å…ˆçº§**: P0

---

#### é—®é¢˜ 2: Context æ•°æ®ç»“æ„å†—ä½™

**ä½ç½®**: `types.ts:51-60`

**é—®é¢˜æè¿°**:
```typescript
export interface StreamingState {
  gatherContent: string        // â† å†—ä½™1: ç”¨äºå‘åå…¼å®¹
  gatherReasoning: string      // â† å†—ä½™2: ç”¨äºå‘åå…¼å®¹
  isContentHasThinkTag: boolean
  tools: ToolRuntimeState
}
```

**åˆ†æ**:
- `gatherContent` å’Œ `gatherReasoning` ä»…åœ¨ `flushToolCallPlaceholder` ä¸­ä½¿ç”¨
- å®é™…å†…å®¹å·²ç»å­˜å‚¨åœ¨ `segments` ä¸­
- è¿™äº›å­—æ®µæ˜¯ä¸ºäº†å‘åå…¼å®¹æ—§ä»£ç è€Œä¿ç•™çš„

**å½±å“**:
- æ•°æ®å†—ä½™ï¼Œå¢åŠ å†…å­˜å ç”¨
- éœ€è¦æ‰‹åŠ¨åŒæ­¥ä¸¤ä»½æ•°æ®
- å®¹æ˜“å‡ºç°æ•°æ®ä¸ä¸€è‡´

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸­é«˜
**ä¼˜å…ˆçº§**: P1

---

#### é—®é¢˜ 3: å¾ªç¯ä¾èµ–å’Œç´§è€¦åˆ

**ä½ç½®**: `streaming.ts:88-112`

**é—®é¢˜æè¿°**:
```typescript
const handleStreamingChunk = (
  context: StreamingContext,  // â† ä¾èµ–æ•´ä¸ª context
  resp: IUnifiedResponse,
  setMessages: (messages: MessageEntity[]) => void,
  parser: ChunkParser
) => {
  // 1. è§£æ
  const result = parser.parse(resp, context.streaming)

  // 2. ç›´æ¥ä¿®æ”¹ context
  context.streaming.tools.toolCalls = result.toolCalls
  context.streaming.isContentHasThinkTag = result.isInThinkTag

  // 3. æ›´æ–° gatherContent/gatherReasoning
  if (result.contentDelta) {
    context.streaming.gatherContent += result.contentDelta  // â† å†—ä½™åŒæ­¥
  }
  if (result.reasoningDelta) {
    context.streaming.gatherReasoning += result.reasoningDelta
  }

  // 4. åº”ç”¨åˆ°æ¶ˆæ¯
  applyParseResult(context, result, setMessages)
}
```

**å½±å“**:
- `handleStreamingChunk` ä¾èµ–æ•´ä¸ª `context`ï¼Œéš¾ä»¥å•ç‹¬æµ‹è¯•
- ç›´æ¥ä¿®æ”¹ `context` çŠ¶æ€ï¼Œå‰¯ä½œç”¨ä¸æ˜æ˜¾
- å†—ä½™çš„ `gatherContent/gatherReasoning` åŒæ­¥

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ä¸­
**ä¼˜å…ˆçº§**: P1

---

### 2.2 ä¸­ç­‰é—®é¢˜ ğŸŸ¡

#### é—®é¢˜ 4: flushToolCallPlaceholder é€»è¾‘æ··ä¹±

**ä½ç½®**: `streaming.ts:180-220`

**é—®é¢˜æè¿°**:
```typescript
private flushToolCallPlaceholder() {
  // 1. ä»å…¨å±€ store è·å–æ¶ˆæ¯ï¼ˆç»•è¿‡ builderï¼‰
  const currentMessages = useChatStore.getState().messages  // â† è¿åæ¶æ„åŸåˆ™

  // 2. æ„é€  assistantToolCallMessage
  const assistantToolCallMessage: ChatMessage = {
    role: 'assistant',
    content: this.context.streaming.gatherContent || '',  // â† ä½¿ç”¨å†—ä½™å­—æ®µ
    toolCalls: this.context.streaming.tools.toolCalls.map(...)
  }

  // 3. æ‰‹åŠ¨æ›´æ–° request.messages
  this.context.request.messages.push(assistantToolCallMessage)

  // 4. æ‰‹åŠ¨æ›´æ–° session.messageEntities
  this.context.session.messageEntities[lastIndex] = { ... }

  // 5. æ‰‹åŠ¨åŒæ­¥
  this.context.session.chatMessages = this.context.session.messageEntities.map(...)
  this.deps.setMessages([...this.context.session.messageEntities])
}
```

**é—®é¢˜**:
- ç›´æ¥è®¿é—®å…¨å±€ storeï¼Œç»•è¿‡äº† builder å’Œ MessageManager
- æ‰‹åŠ¨åŒæ­¥ 3 ä¸ªåœ°æ–¹ï¼ˆè¿åäº† MessageManager çš„è®¾è®¡åˆè¡·ï¼‰
- ä½¿ç”¨å†—ä½™çš„ `gatherContent` å­—æ®µ

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­
**ä¼˜å…ˆçº§**: P2

---

#### é—®é¢˜ 5: Parser å±‚çŠ¶æ€ç®¡ç†ä¸æ¸…æ™°

**ä½ç½®**: `streaming/parser/chunk-parser.ts:22-60`

**é—®é¢˜æè¿°**:
```typescript
parse(chunk: IUnifiedResponse, currentState: StreamingState): ParseResult {
  let hasThinkTag = currentState.isContentHasThinkTag  // â† ä»å¤–éƒ¨è¯»å–çŠ¶æ€
  let isInThinkTag = currentState.isContentHasThinkTag

  // ... è§£æé€»è¾‘

  return {
    contentDelta,
    reasoningDelta,
    toolCalls,
    hasThinkTag,      // â† è¿”å›æ–°çŠ¶æ€
    isInThinkTag
  }
}
```

**é—®é¢˜**:
- Parser æ—¢è¯»å–å¤–éƒ¨çŠ¶æ€ï¼Œåˆè¿”å›æ–°çŠ¶æ€
- çŠ¶æ€æ›´æ–°è´£ä»»ä¸æ¸…æ™°ï¼ˆè°è´Ÿè´£æ›´æ–° `currentState.isContentHasThinkTag`ï¼Ÿï¼‰
- ThinkTagParser å†…éƒ¨ç»´æŠ¤çŠ¶æ€ï¼Œä½† ChunkParser ä¹Ÿç»´æŠ¤çŠ¶æ€

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ä½
**ä¼˜å…ˆçº§**: P2

---

#### é—®é¢˜ 6: é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€

**ä½ç½®**: å¤šå¤„

**é—®é¢˜æè¿°**:
```typescript
// streaming.ts:155
try {
  // ... æµå¼å¤„ç†
} catch (error: any) {
  if (this.context.control.signal.aborted) {
    throw new AbortError()
  }
  // å…¶ä»–é”™è¯¯ç›´æ¥æŠ›å‡º
}

// ToolExecutor ä¸­
catch (error: any) {
  const result = this.createErrorResult(call, error, ...)
  return result  // â† ä¸æŠ›å‡ºï¼Œè¿”å›é”™è¯¯ç»“æœ
}

// finalize.ts ä¸­
catch (error) {
  console.error('Failed to save message:', error)  // â† åªæ‰“å°æ—¥å¿—
}
```

**é—®é¢˜**:
- ä¸åŒå±‚çº§çš„é”™è¯¯å¤„ç†ç­–ç•¥ä¸ä¸€è‡´
- æœ‰çš„æŠ›å‡ºå¼‚å¸¸ï¼Œæœ‰çš„è¿”å›é”™è¯¯ç»“æœï¼Œæœ‰çš„åªæ‰“å°æ—¥å¿—
- ç¼ºä¹ç»Ÿä¸€çš„é”™è¯¯æ¢å¤æœºåˆ¶

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ä½
**ä¼˜å…ˆçº§**: P2

---

### 2.3 è½»å¾®é—®é¢˜ ğŸŸ¢

#### é—®é¢˜ 7: ç±»å‹å®šä¹‰åˆ†æ•£

**ä½ç½®**: `types.ts`

**é—®é¢˜æè¿°**:
- 187 è¡Œçš„ç±»å‹å®šä¹‰æ–‡ä»¶ï¼ŒåŒ…å«äº†æ‰€æœ‰é˜¶æ®µçš„ç±»å‹
- ç¼ºä¹æ¨¡å—åŒ–ç»„ç»‡
- éš¾ä»¥å¿«é€Ÿå®šä½ç‰¹å®šç±»å‹

**å»ºè®®**:
```
types/
â”œâ”€â”€ prepare.types.ts
â”œâ”€â”€ request.types.ts
â”œâ”€â”€ streaming.types.ts
â”œâ”€â”€ finalize.types.ts
â””â”€â”€ index.ts
```

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½
**ä¼˜å…ˆçº§**: P3

---

#### é—®é¢˜ 8: ç¼ºä¹æ—¥å¿—å’Œç›‘æ§

**ä½ç½®**: å…¨å±€

**é—®é¢˜æè¿°**:
- åªæœ‰é›¶æ•£çš„ `console.log` å’Œ `console.error`
- ç¼ºä¹ç»“æ„åŒ–æ—¥å¿—
- æ— æ³•è¿½è¸ªå®Œæ•´çš„è¯·æ±‚é“¾è·¯
- éš¾ä»¥æ’æŸ¥ç”Ÿäº§ç¯å¢ƒé—®é¢˜

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½
**ä¼˜å…ˆçº§**: P3

---

#### é—®é¢˜ 9: æµ‹è¯•è¦†ç›–ç‡ä½

**ä½ç½®**: å…¨å±€

**é—®é¢˜æè¿°**:
- æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å•å…ƒæµ‹è¯•æ–‡ä»¶
- æ ¸å¿ƒé€»è¾‘ï¼ˆParserã€ToolExecutorã€MessageManagerï¼‰æœªæµ‹è¯•
- é‡æ„é£é™©é«˜

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½
**ä¼˜å…ˆçº§**: P3

---

## ä¸‰ã€ä¼˜åŒ–æ–¹æ¡ˆä¸€ï¼šæ¸è¿›å¼ä¼˜åŒ–ï¼ˆæ¨èï¼‰

### 3.1 Phase 3: é‡æ„ StreamingSessionMachine

**ç›®æ ‡**: æ‹†åˆ†èŒè´£ï¼Œæå–ç‹¬ç«‹çš„ Orchestrator

#### 3.1.1 åˆ›å»º StreamingOrchestrator

```typescript
// streaming/orchestrator.ts

/**
 * æµå¼ç¼–æ’å™¨
 * èŒè´£ï¼šåè°ƒæµå¼è¯·æ±‚ã€å·¥å…·è°ƒç”¨ã€æ¶ˆæ¯æ›´æ–°
 */
export class StreamingOrchestrator {
  constructor(
    private readonly context: StreamingContext,
    private readonly deps: StreamingDeps,
    private readonly parser: ChunkParser,
    private readonly toolExecutor: ToolExecutor,
    private readonly messageManager: MessageManager
  ) {}

  /**
   * æ‰§è¡Œå•æ¬¡è¯·æ±‚-å“åº”å¾ªç¯
   */
  async executeRequestCycle(): Promise<void> {
    // 1. å‘é€è¯·æ±‚
    await this.sendRequest()

    // 2. å¦‚æœæœ‰å·¥å…·è°ƒç”¨ï¼Œæ‰§è¡Œå·¥å…·
    if (this.hasToolCalls()) {
      await this.executeTools()
    }
  }

  private async sendRequest(): Promise<void> {
    const response = await unifiedChatRequest(...)

    if (this.context.request.stream === false) {
      this.handleNonStreamingResponse(response)
      return
    }

    for await (const chunk of response) {
      this.handleStreamingChunk(chunk)
    }
  }

  private handleStreamingChunk(chunk: IUnifiedResponse): void {
    const result = this.parser.parse(chunk, this.context.streaming)
    this.applyParseResult(result)
  }

  private async executeTools(): Promise<void> {
    const results = await this.toolExecutor.execute(
      this.context.streaming.tools.toolCalls
    )
    this.applyToolResults(results)
  }
}
```

**æ”¶ç›Š**:
- èŒè´£æ¸…æ™°ï¼šåªè´Ÿè´£ç¼–æ’ï¼Œä¸å¤„ç†å…·ä½“é€»è¾‘
- æ˜“äºæµ‹è¯•ï¼šä¾èµ–æ³¨å…¥ï¼Œå¯ä»¥ mock æ‰€æœ‰ä¾èµ–
- ä»£ç è¡Œæ•°å‡å°‘ï¼šä» 330 è¡Œå‡å°‘åˆ° ~150 è¡Œ

---

#### 3.1.2 ç®€åŒ– StreamingSessionMachine

```typescript
// streaming.ts (é‡æ„å)

class StreamingSessionMachine {
  private orchestrator: StreamingOrchestrator

  constructor(
    requestReady: PreparedRequest,
    private readonly deps: StreamingDeps,
    private readonly callbacks?: StreamingFactoryCallbacks
  ) {
    this.context = { ...requestReady, streaming: createInitialStreamingState() }

    // ç»„è£…ä¾èµ–
    const parser = new ChunkParser()
    const toolExecutor = new ToolExecutor({ ... })
    const messageManager = new MessageManager(this.context, deps.setMessages)

    this.orchestrator = new StreamingOrchestrator(
      this.context,
      deps,
      parser,
      toolExecutor,
      messageManager
    )
  }

  async start(): Promise<StreamingContext> {
    while (true) {
      await this.orchestrator.executeRequestCycle()

      if (!this.orchestrator.hasToolCalls()) {
        break
      }
    }

    return this.context
  }
}
```

**æ”¶ç›Š**:
- StreamingSessionMachine å˜æˆè½»é‡çº§çš„åè°ƒå™¨
- æ ¸å¿ƒé€»è¾‘ç§»åˆ° StreamingOrchestrator
- æ›´å®¹æ˜“ç†è§£å’Œç»´æŠ¤


### 3.2 Phase 4: ç§»é™¤å†—ä½™å­—æ®µ

**ç›®æ ‡**: ç§»é™¤ `gatherContent` å’Œ `gatherReasoning`

#### 3.2.1 ä¿®æ”¹ StreamingState

```typescript
// types.ts (ä¿®æ”¹å‰)
export interface StreamingState {
  gatherContent: string        // â† åˆ é™¤
  gatherReasoning: string      // â† åˆ é™¤
  isContentHasThinkTag: boolean
  tools: ToolRuntimeState
}

// types.ts (ä¿®æ”¹å)
export interface StreamingState {
  isContentHasThinkTag: boolean
  tools: ToolRuntimeState
}
```

#### 3.2.2 ä¿®æ”¹ flushToolCallPlaceholder

```typescript
// ä¿®æ”¹å‰
private flushToolCallPlaceholder() {
  const assistantToolCallMessage: ChatMessage = {
    role: 'assistant',
    content: this.context.streaming.gatherContent || '',  // â† ä½¿ç”¨å†—ä½™å­—æ®µ
    toolCalls: ...
  }
}

// ä¿®æ”¹å
private flushToolCallPlaceholder() {
  // ä» segments ä¸­æå– content
  const lastMessage = this.messageManager.getLastMessage()
  const textSegments = lastMessage.body.segments?.filter(s => s.type === 'text') || []
  const content = textSegments.map(s => s.content).join('')

  const assistantToolCallMessage: ChatMessage = {
    role: 'assistant',
    content,  // â† ä» segments è®¡ç®—
    toolCalls: ...
  }
}
```

**æ”¶ç›Š**:
- æ¶ˆé™¤æ•°æ®å†—ä½™
- å•ä¸€æ•°æ®æºï¼ˆsegmentsï¼‰
- å‡å°‘åŒæ­¥é”™è¯¯çš„å¯èƒ½æ€§

---

### 3.3 Phase 5: ç»Ÿä¸€é”™è¯¯å¤„ç†

**ç›®æ ‡**: å»ºç«‹ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ç­–ç•¥

#### 3.3.1 åˆ›å»º ErrorHandler

```typescript
// errors/error-handler.ts

export enum ErrorSeverity {
  Fatal = 'fatal',              // ä¸­æ­¢æ•´ä¸ªæµç¨‹
  Recoverable = 'recoverable',  // å¯ä»¥ç»§ç»­
  Warning = 'warning'           // åªè®°å½•æ—¥å¿—
}

export interface ErrorContext {
  phase: 'prepare' | 'request' | 'streaming' | 'toolCall' | 'finalize'
  operation: string
  error: Error
}

export class ErrorHandler {
  handle(context: ErrorContext): ErrorSeverity {
    // 1. åˆ†ç±»é”™è¯¯
    const severity = this.classifyError(context.error)

    // 2. è®°å½•æ—¥å¿—
    this.logError(context, severity)

    // 3. ä¸ŠæŠ¥ç›‘æ§
    this.reportToMonitoring(context, severity)

    return severity
  }

  private classifyError(error: Error): ErrorSeverity {
    if (error.name === 'AbortError') return ErrorSeverity.Fatal
    if (error.name === 'NetworkError') return ErrorSeverity.Recoverable
    if (error.name === 'ToolExecutionError') return ErrorSeverity.Warning
    return ErrorSeverity.Fatal
  }
}
```

**æ”¶ç›Š**:
- ç»Ÿä¸€çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†
- ç»“æ„åŒ–æ—¥å¿—
- ä¾¿äºç›‘æ§å’Œå‘Šè­¦


---

## å››ã€ä¼˜åŒ–æ–¹æ¡ˆäºŒï¼šæ›´æ¿€è¿›çš„æ¶æ„é‡æ„

### 4.1 æ ¸å¿ƒæ€æƒ³ï¼šäº‹ä»¶é©±åŠ¨ + å“åº”å¼çŠ¶æ€

**é—®é¢˜**: å½“å‰æ¶æ„ä¸­ï¼ŒçŠ¶æ€æ›´æ–°æ˜¯å‘½ä»¤å¼çš„ï¼Œéœ€è¦æ‰‹åŠ¨åŒæ­¥å¤šä¸ªåœ°æ–¹ã€‚

**æ–¹æ¡ˆ**: å¼•å…¥äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œå°†çŠ¶æ€æ›´æ–°æ”¹ä¸ºå“åº”å¼ã€‚

#### 4.1.1 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          EventBus (äº‹ä»¶æ€»çº¿)                             â”‚
â”‚  - chunk.received                                       â”‚
â”‚  - message.updated                                      â”‚
â”‚  - tool.started / tool.completed / tool.failed          â”‚
â”‚  - streaming.completed                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ è®¢é˜…
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          StateManager (å“åº”å¼çŠ¶æ€)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è‡ªåŠ¨åŒæ­¥ï¼š                                       â”‚  â”‚
â”‚  â”‚  - messageEntities â†’ chatMessages                  â”‚  â”‚
â”‚  â”‚  - segments â†’ UI                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.1.2 å®ç°ç¤ºä¾‹

```typescript
// events/event-bus.ts

type EventMap = {
  'chunk.received': IUnifiedResponse
  'message.updated': MessageEntity[]
  'tool.started': { id: string; name: string }
  'tool.completed': ToolExecutionResult
  'tool.failed': { id: string; name: string; error: Error }
}

class EventBus {
  private listeners = new Map<keyof EventMap, Set<Function>>()

  on<K extends keyof EventMap>(
    event: K,
    handler: (data: EventMap[K]) => void
  ) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, new Set())
    }
    this.listeners.get(event)!.add(handler)
  }

  emit<K extends keyof EventMap>(event: K, data: EventMap[K]) {
    this.listeners.get(event)?.forEach(handler => handler(data))
  }
}
```


#### 4.1.3 ä½¿ç”¨ç¤ºä¾‹

```typescript
// streaming/orchestrator.ts (äº‹ä»¶é©±åŠ¨ç‰ˆæœ¬)

class EventDrivenOrchestrator {
  constructor(
    private readonly eventBus: EventBus,
    private readonly parser: ChunkParser
  ) {
    this.setupEventHandlers()
  }

  private setupEventHandlers() {
    // è®¢é˜… chunk äº‹ä»¶
    this.eventBus.on('chunk.received', (chunk) => {
      const result = this.parser.parse(chunk, ...)
      this.eventBus.emit('message.updated', updatedMessages)
    })

    // è®¢é˜…å·¥å…·å®Œæˆäº‹ä»¶
    this.eventBus.on('tool.completed', (result) => {
      // è‡ªåŠ¨æ›´æ–°æ¶ˆæ¯
      this.eventBus.emit('message.updated', updatedMessages)
    })
  }

  async start() {
    for await (const chunk of response) {
      // åªéœ€è¦å‘å°„äº‹ä»¶ï¼Œä¸éœ€è¦æ‰‹åŠ¨æ›´æ–°çŠ¶æ€
      this.eventBus.emit('chunk.received', chunk)
    }
  }
}
```

#### 4.1.4 ä¼˜åŠ¿ä¸åŠ£åŠ¿

**ä¼˜åŠ¿**:
- âœ… å®Œå…¨è§£è€¦ï¼šParserã€ToolExecutorã€StateManager é€šè¿‡äº‹ä»¶é€šä¿¡
- âœ… è‡ªåŠ¨åŒæ­¥ï¼šè®¢é˜…äº‹ä»¶åè‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨åŒæ­¥
- âœ… æ˜“äºæ‰©å±•ï¼šæ·»åŠ æ–°åŠŸèƒ½åªéœ€è®¢é˜…äº‹ä»¶
- âœ… æ›´å¥½çš„æµ‹è¯•æ€§ï¼šå¯ä»¥æµ‹è¯•äº‹ä»¶è§¦å‘ï¼Œæ— éœ€ mock æ•´ä¸ª context

**åŠ£åŠ¿**:
- âŒ å¤æ‚åº¦å¢åŠ ï¼šéœ€è¦ç†è§£äº‹ä»¶é©±åŠ¨æ¨¡å¼
- âŒ è°ƒè¯•éš¾åº¦ï¼šäº‹ä»¶æµä¸å¦‚ç›´æ¥è°ƒç”¨ç›´è§‚
- âŒ é‡æ„æˆæœ¬é«˜ï¼šéœ€è¦æ”¹å†™å¤§é‡ç°æœ‰ä»£ç 
- âŒ å¯èƒ½è¿‡åº¦è®¾è®¡ï¼šå¯¹äºå½“å‰è§„æ¨¡å¯èƒ½ä¸å¤Ÿå®ç”¨


---

## äº”ã€æ¨èå®æ–½è·¯å¾„

### 5.1 çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

**ä¼˜å…ˆçº§ P0-P1 é—®é¢˜**

1. **Phase 3: é‡æ„ StreamingSessionMachine**
   - æå– StreamingOrchestrator
   - æ‹†åˆ†èŒè´£ï¼Œé™ä½å¤æ‚åº¦
   - é¢„è®¡å·¥ä½œé‡ï¼š3-4å¤©

2. **Phase 4: ç§»é™¤å†—ä½™å­—æ®µ**
   - åˆ é™¤ `gatherContent` å’Œ `gatherReasoning`
   - ä¿®æ”¹ `flushToolCallPlaceholder` é€»è¾‘
   - é¢„è®¡å·¥ä½œé‡ï¼š1-2å¤©

3. **ä¿®å¤ flushToolCallPlaceholder**
   - ä½¿ç”¨ MessageManager è€Œä¸æ˜¯ç›´æ¥è®¿é—® store
   - é¢„è®¡å·¥ä½œé‡ï¼šåŠå¤©

### 5.2 ä¸­æœŸä¼˜åŒ–ï¼ˆ2-4å‘¨ï¼‰

**ä¼˜å…ˆçº§ P2 é—®é¢˜**

1. **Phase 5: ç»Ÿä¸€é”™è¯¯å¤„ç†**
   - åˆ›å»º ErrorHandler
   - å»ºç«‹é”™è¯¯åˆ†ç±»ä½“ç³»
   - é¢„è®¡å·¥ä½œé‡ï¼š2-3å¤©

2. **ä¼˜åŒ– Parser å±‚çŠ¶æ€ç®¡ç†**
   - æ˜ç¡®çŠ¶æ€æ›´æ–°è´£ä»»
   - ç®€åŒ–çŠ¶æ€ä¼ é€’
   - é¢„è®¡å·¥ä½œé‡ï¼š2å¤©

3. **æ·»åŠ å•å…ƒæµ‹è¯•**
   - Parser å±‚æµ‹è¯•
   - ToolExecutor æµ‹è¯•
   - MessageManager æµ‹è¯•
   - é¢„è®¡å·¥ä½œé‡ï¼š3-4å¤©

### 5.3 é•¿æœŸä¼˜åŒ–ï¼ˆ1-2æœˆï¼‰

**ä¼˜å…ˆçº§ P3 é—®é¢˜**

1. **æ¨¡å—åŒ–ç±»å‹å®šä¹‰**
   - æ‹†åˆ† types.ts
   - æŒ‰æ¨¡å—ç»„ç»‡ç±»å‹
   - é¢„è®¡å·¥ä½œé‡ï¼š1å¤©

2. **æ·»åŠ æ—¥å¿—å’Œç›‘æ§**
   - ç»“æ„åŒ–æ—¥å¿—
   - æ€§èƒ½ç›‘æ§
   - é”™è¯¯è¿½è¸ª
   - é¢„è®¡å·¥ä½œé‡ï¼š3-5å¤©

3. **è€ƒè™‘äº‹ä»¶é©±åŠ¨æ¶æ„**
   - ä»…åœ¨å›¢é˜Ÿè§„æ¨¡æ‰©å¤§æˆ–éœ€æ±‚å¤æ‚åŒ–æ—¶è€ƒè™‘
   - éœ€è¦å……åˆ†è¯„ä¼°æ”¶ç›Šå’Œæˆæœ¬


---

## å…­ã€æ–¹æ¡ˆå¯¹æ¯”ä¸æ€»ç»“

### 6.1 ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | æ–¹æ¡ˆä¸€ï¼šæ¸è¿›å¼ä¼˜åŒ– | æ–¹æ¡ˆäºŒï¼šäº‹ä»¶é©±åŠ¨ |
|------|-------------------|-----------------|
| **å¤æ‚åº¦** | ä¸­ | é«˜ |
| **å®æ–½é£é™©** | ä½ | é«˜ |
| **é‡æ„æˆæœ¬** | ä¸­ï¼ˆ2-4å‘¨ï¼‰ | é«˜ï¼ˆ1-2æœˆï¼‰ |
| **ä»£ç è¡Œæ•°** | â†“20-30% | â†‘10-20% |
| **å¯ç»´æŠ¤æ€§** | é«˜ | æé«˜ |
| **å¯æµ‹è¯•æ€§** | é«˜ | æé«˜ |
| **å­¦ä¹ æ›²çº¿** | å¹³ç¼“ | é™¡å³­ |
| **é€‚ç”¨åœºæ™¯** | å½“å‰è§„æ¨¡ | å¤§å‹å›¢é˜Ÿ/å¤æ‚éœ€æ±‚ |

### 6.2 æ ¸å¿ƒå»ºè®®

#### âœ… æ¨èï¼šæ–¹æ¡ˆä¸€ï¼ˆæ¸è¿›å¼ä¼˜åŒ–ï¼‰

**ç†ç”±**:
1. **é£é™©å¯æ§**: é€æ­¥ä¼˜åŒ–ï¼Œæ¯ä¸ª Phase éƒ½å¯ä»¥ç‹¬ç«‹éªŒè¯
2. **æ”¶ç›Šæ˜ç¡®**: æ¯ä¸ªä¼˜åŒ–éƒ½æœ‰æ¸…æ™°çš„æ”¶ç›ŠæŒ‡æ ‡
3. **æ˜“äºå›æ»š**: å¦‚æœæŸä¸ª Phase æœ‰é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›é€€
4. **ç¬¦åˆå½“å‰è§„æ¨¡**: ä¸ä¼šè¿‡åº¦è®¾è®¡

**å®æ–½é¡ºåº**:
```
Phase 3: StreamingOrchestrator (P0)
    â†“
Phase 4: ç§»é™¤å†—ä½™å­—æ®µ (P1)
    â†“
Phase 5: ç»Ÿä¸€é”™è¯¯å¤„ç† (P2)
    â†“
æ·»åŠ å•å…ƒæµ‹è¯• (P2)
    â†“
å…¶ä»–ä¼˜åŒ– (P3)
```

#### âš ï¸ è°¨æ…è€ƒè™‘ï¼šæ–¹æ¡ˆäºŒï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰

**ä½•æ—¶è€ƒè™‘**:
- âœ… æ–¹æ¡ˆä¸€å…¨éƒ¨å®Œæˆï¼Œä¸”éªŒè¯äº†æ”¶ç›Š
- âœ… å›¢é˜Ÿè§„æ¨¡æ‰©å¤§ï¼ˆ>3äººåŒæ—¶å¼€å‘æ­¤æ¨¡å—ï¼‰
- âœ… éœ€è¦æ·»åŠ å¤æ‚çš„å¼‚æ­¥åè°ƒï¼ˆå¦‚å¤šè½®å¯¹è¯ã€åˆ†æ”¯å¤„ç†ï¼‰
- âœ… éœ€è¦å¼ºå¤§çš„å¯è§‚æµ‹æ€§ï¼ˆå¦‚æ—¥å¿—ã€æŒ‡æ ‡ã€tracingï¼‰

**ä¸å»ºè®®çš„æƒ…å†µ**:
- âŒ å½“å‰å›¢é˜Ÿè§„æ¨¡å°
- âŒ éœ€æ±‚ç›¸å¯¹ç¨³å®š
- âŒ æ²¡æœ‰å……åˆ†çš„æµ‹è¯•è¦†ç›–


---

## ä¸ƒã€å…³é”®æŒ‡æ ‡å¯¹æ¯”

### 7.1 ä¼˜åŒ–å‰åå¯¹æ¯”

| æŒ‡æ ‡ | å½“å‰çŠ¶æ€ | Phase 3 å®Œæˆå | å…¨éƒ¨å®Œæˆå |
|------|---------|---------------|-----------|
| **StreamingSessionMachine è¡Œæ•°** | 330 è¡Œ | ~150 è¡Œ (â†“55%) | ~100 è¡Œ (â†“70%) |
| **çŠ¶æ€åŒæ­¥ç‚¹** | 9 å¤„ | 3 å¤„ (â†“67%) | 1 å¤„ (â†“89%) |
| **å†—ä½™å­—æ®µ** | 2 ä¸ª | 2 ä¸ª | 0 ä¸ª (â†“100%) |
| **èŒè´£æ•°é‡** | 5 ä¸ª | 2 ä¸ª (â†“60%) | 1 ä¸ª (â†“80%) |
| **å¯æµ‹è¯•æ€§** | ä½ | ä¸­ | é«˜ |
| **ä»£ç å¤æ‚åº¦** | é«˜ | ä¸­ | ä½ |

### 7.2 é¢„æœŸæ”¶ç›Š

**çŸ­æœŸæ”¶ç›Š**ï¼ˆPhase 3-4 å®Œæˆåï¼‰:
- âœ… ä»£ç è¡Œæ•°å‡å°‘ 50%+
- âœ… èŒè´£æ¸…æ™°ï¼Œæ˜“äºç†è§£
- âœ… æ¶ˆé™¤æ•°æ®å†—ä½™
- âœ… å‡å°‘ bug é£é™©

**ä¸­æœŸæ”¶ç›Š**ï¼ˆPhase 5 + æµ‹è¯•å®Œæˆåï¼‰:
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- âœ… é«˜æµ‹è¯•è¦†ç›–ç‡
- âœ… æ›´å®¹æ˜“æ·»åŠ æ–°åŠŸèƒ½
- âœ… æ›´å®¹æ˜“æ’æŸ¥é—®é¢˜

**é•¿æœŸæ”¶ç›Š**ï¼ˆå…¨éƒ¨å®Œæˆåï¼‰:
- âœ… æ¶æ„æ¸…æ™°ï¼Œæ–‡æ¡£å®Œå–„
- âœ… æ–°äººä¸Šæ‰‹å¿«
- âœ… ç»´æŠ¤æˆæœ¬ä½
- âœ… å¯æ‰©å±•æ€§å¼º


---

## å…«ã€ç»“è®º

### 8.1 å½“å‰æ¶æ„è¯„ä»·

**ä¼˜ç‚¹** âœ…:
- Pipeline æ¶æ„æ¸…æ™°ï¼Œé˜¶æ®µåˆ’åˆ†åˆç†
- MessageManager å’Œ ToolExecutor å·²ç»å¾ˆå¥½åœ°åˆ†ç¦»äº†èŒè´£
- Parser å±‚è®¾è®¡è‰¯å¥½ï¼Œæ˜“äºæ‰©å±•
- ç±»å‹å®‰å…¨ï¼ŒTypeScript ç±»å‹å®šä¹‰å®Œå–„

**ä¸»è¦é—®é¢˜** âš ï¸:
- StreamingSessionMachine èŒè´£è¿‡é‡ï¼ˆ5ä¸ªèŒè´£ï¼‰
- å­˜åœ¨å†—ä½™å­—æ®µï¼ˆgatherContent/gatherReasoningï¼‰
- éƒ¨åˆ†ä»£ç ç»•è¿‡æ¶æ„åŸåˆ™ï¼ˆç›´æ¥è®¿é—® storeï¼‰
- é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€
- ç¼ºä¹æµ‹è¯•è¦†ç›–

### 8.2 æœ€ç»ˆå»ºè®®

**ç«‹å³æ‰§è¡Œ**ï¼ˆP0ï¼‰:
1. Phase 3: æå– StreamingOrchestrator
   - è¿™æ˜¯æœ€é‡è¦çš„ä¼˜åŒ–
   - å¯ä»¥ç«‹å³é™ä½å¤æ‚åº¦
   - ä¸ºåç»­ä¼˜åŒ–æ‰“å¥½åŸºç¡€

**è¿‘æœŸæ‰§è¡Œ**ï¼ˆP1ï¼‰:
2. Phase 4: ç§»é™¤å†—ä½™å­—æ®µ
3. ä¿®å¤ flushToolCallPlaceholder

**ä¸­æœŸè§„åˆ’**ï¼ˆP2ï¼‰:
4. Phase 5: ç»Ÿä¸€é”™è¯¯å¤„ç†
5. æ·»åŠ å•å…ƒæµ‹è¯•
6. ä¼˜åŒ– Parser å±‚çŠ¶æ€ç®¡ç†

**é•¿æœŸè€ƒè™‘**ï¼ˆP3ï¼‰:
7. æ¨¡å—åŒ–ç±»å‹å®šä¹‰
8. æ·»åŠ æ—¥å¿—å’Œç›‘æ§
9. è¯„ä¼°æ˜¯å¦éœ€è¦äº‹ä»¶é©±åŠ¨æ¶æ„

### 8.3 ä¸å»ºè®®çš„åšæ³•

âŒ **ä¸è¦ä¸€æ¬¡æ€§é‡æ„æ‰€æœ‰ä»£ç **
- é£é™©å¤ªé«˜ï¼Œéš¾ä»¥å›æ»š
- å»ºè®®æŒ‰ Phase é€æ­¥ä¼˜åŒ–

âŒ **ä¸è¦è¿‡æ—©å¼•å…¥äº‹ä»¶é©±åŠ¨æ¶æ„**
- å½“å‰è§„æ¨¡ä¸éœ€è¦
- ç­‰æ–¹æ¡ˆä¸€å®Œæˆåå†è¯„ä¼°

âŒ **ä¸è¦å¿½ç•¥æµ‹è¯•**
- é‡æ„å¿…é¡»æœ‰æµ‹è¯•ä¿æŠ¤
- å»ºè®®åœ¨ Phase 3 å®Œæˆåç«‹å³æ·»åŠ æµ‹è¯•

---

## é™„å½•ï¼šå‚è€ƒèµ„æ–™

- [æ¶æ„ä¼˜åŒ–.md](./æ¶æ„ä¼˜åŒ–.md) - Phase 1-2 çš„è¯¦ç»†è¯´æ˜
- [message-manager-plan.md](./message-manager-plan.md) - MessageManager è®¾è®¡æ–‡æ¡£

